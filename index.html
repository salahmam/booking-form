<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لعبة السودوكو</title>
  <style>
    body{font-family:Arial;text-align:center;background:#f8f9fa;}
    #ad-banner{margin:10px auto;width:100%;max-width:728px;height:90px;background:#ddd;display:flex;align-items:center;justify-content:center;}
    #board{display:grid;margin:20px auto;gap:2px;max-width:90vmin;}
    .cell{border:1px solid #444;display:flex;align-items:center;justify-content:center;font-size:calc(1.5vmin + 10px);width:100%;aspect-ratio:1;background:#fff;}
    .cell[data-editable="true"]{background:#eef;}
    .cell[data-selected="true"]{outline:2px solid #2f7bff;}
    .shake{animation:shake 0.3s;}
    .pop{animation:pop 0.3s;}
    @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-4px);}75%{transform:translateX(4px);}}
    @keyframes pop{0%{transform:scale(0.8);}100%{transform:scale(1);}}
    #progress{height:10px;background:#ccc;margin:10px auto;width:80%;border-radius:5px;overflow:hidden;}
    #progress span{display:block;height:100%;background:#27c93f;width:0%;}
    #controls button{margin:5px;padding:8px 15px;}
    #status{margin-top:10px;font-weight:bold;}
    canvas#confetti{position:absolute;left:0;top:0;pointer-events:none;}
  </style>
</head>
<body>
  <h2>🎯 لعبة السودوكو</h2>
  <div id="ad-banner">إعلان Google (728×90)</div>

  <div>
    المستوى:
    <select id="levelSel"></select>
    المرحلة:
    <select id="stageSel"></select>
  </div>
  <div id="progress"><span></span></div>
  <div id="board"></div>
  <div id="controls">
    <button id="btnReset">🔄 إعادة</button>
    <button id="btnCheck">✅ تحقق</button>
    <button id="btnNext">➡️ المرحلة التالية</button>
  </div>
  <div id="status"></div>
  <canvas id="confetti"></canvas>

  <!-- صوت النقر -->
  <audio id="clickSound" src="https://assets.mixkit.co/sfx/download/mixkit-interface-click-1126.wav"></audio>
  <!-- صوت الفوز -->
  <audio id="winSound" src="https://assets.mixkit.co/sfx/download/mixkit-achievement-bell-600.wav"></audio>

  <script>
    const boardEl=document.getElementById("board"),
          progressEl=document.querySelector("#progress span"),
          stageSel=document.getElementById("stageSel"),
          levelSel=document.getElementById("levelSel"),
          btnReset=document.getElementById("btnReset"),
          btnCheck=document.getElementById("btnCheck"),
          btnNext=document.getElementById("btnNext"),
          statusEl=document.getElementById("status"),
          confettiCanvas=document.getElementById("confetti"),
          ctx=confettiCanvas.getContext("2d"),
          clickSound=document.getElementById("clickSound"),
          winSound=document.getElementById("winSound");

    let SIDE=4, currentLevel=1, currentStage=1, solutionBoard=[], initialBoard=[];

    function $(s){return document.querySelector(s);}
    function $$(s){return document.querySelectorAll(s);}
    function playClick(){clickSound.currentTime=0;clickSound.play();}
    function playWin(){winSound.currentTime=0;winSound.play();}

    /************** Sudoku Generator **************/
    function generateFull(N){
      const board=Array.from({length:N},()=>Array(N).fill(0));
      function isValid(r,c,num){
        for(let i=0;i<N;i++){
          if(board[r][i]===num||board[i][c]===num) return false;
        }
        return true;
      }
      function backtrack(r=0,c=0){
        if(r===N) return true;
        let nr=r+(c+1===N), nc=(c+1)%N;
        const nums=[...Array(N).keys()].map(x=>x+1).sort(()=>Math.random()-0.5);
        for(const num of nums){
          if(isValid(r,c,num)){
            board[r][c]=num;
            if(backtrack(r+(c+1===N), (c+1)%N)) return true;
            board[r][c]=0;
          }
        }
        return false;
      }
      backtrack();
      return board;
    }

    function removeCells(board,count){
      const copy=board.map(r=>[...r]);
      let removed=0, N=board.length;
      while(removed<count){
        let r=Math.floor(Math.random()*N),c=Math.floor(Math.random()*N);
        if(copy[r][c]!==0){copy[r][c]=0;removed++;}
      }
      return copy;
    }

    /************** Render **************/
    function makeCell(r,c,val,editable){
      const d=document.createElement("div");
      d.className="cell";
      d.dataset.r=r;d.dataset.c=c;
      d.dataset.editable=editable?"true":"false";
      d.tabIndex=0;
      if(val!==0) d.textContent=val;
      if(editable) d.contentEditable="true"; else d.contentEditable="false";
      return d;
    }

    function renderBoard(board){
      boardEl.innerHTML="";
      SIDE=board.length;
      boardEl.style.gridTemplateColumns=`repeat(${SIDE},1fr)`;
      for(let r=0;r<SIDE;r++){
        for(let c=0;c<SIDE;c++){
          const val=board[r][c];
          const editable=(val===0);
          boardEl.appendChild(makeCell(r,c,val,editable));
        }
      }
      attachEvents();
    }

    function attachEvents(){
      $$(".cell[data-editable='true']").forEach(cell=>{
        cell.addEventListener("focus", e=>{
          $$("[data-selected='true']").forEach(x=>x.dataset.selected="false");
          e.currentTarget.dataset.selected="true";
        });
        cell.addEventListener("blur", e=>{
          e.currentTarget.dataset.selected="false";
        });
        cell.addEventListener("input", e=>{
          playClick();
          let val=e.currentTarget.textContent.trim();
          if(!/^[1-9]$/.test(val) || +val>SIDE){
            e.currentTarget.textContent="";
            return;
          }
          updateProgress();
        });
        cell.addEventListener("keydown", e=>{
          if(e.key==="Backspace"||e.key==="Delete"){
            e.preventDefault();playClick();
            e.currentTarget.textContent="";
            updateProgress();
          }
        });
      });
    }

    function currentBoard(){
      return $$(".cell").reduce((acc,cell)=>{
        const r=+cell.dataset.r,c=+cell.dataset.c;
        if(!acc[r]) acc[r]=[];
        acc[r][c]=parseInt(cell.textContent)||0;
        return acc;
      },[]);
    }

    function updateProgress(){
      const b=currentBoard();
      let filled=0;
      for(let r=0;r<SIDE;r++){
        for(let c=0;c<SIDE;c++){
          if(b[r][c]!==0) filled++;
        }
      }
      progressEl.style.width=(filled/(SIDE*SIDE))*100+"%";
    }

    /************** Game Flow **************/
    function newStage(level,stage){
      currentLevel=level;currentStage=stage;
      SIDE=level+3; // Level1=4x4 ... Level6=9x9
      const full=generateFull(SIDE);
      solutionBoard=full;
      const blanks=Math.floor(SIDE*SIDE*0.4); // نسبة فراغات
      initialBoard=removeCells(full,blanks);
      renderBoard(initialBoard);
      updateProgress();
      statusEl.textContent=`المستوى ${level} - المرحلة ${stage}`;
    }

    function resetStage(){
      renderBoard(initialBoard);
      updateProgress();
      statusEl.textContent="إعادة المرحلة";
    }

    function checkBoard(){
      const b=currentBoard();
      for(let r=0;r<SIDE;r++){
        for(let c=0;c<SIDE;c++){
          if(b[r][c]!==solutionBoard[r][c]){
            statusEl.textContent="❌ هناك أخطاء";
            return false;
          }
        }
      }
      statusEl.textContent="✅ فوز!";
      playWin();
      confetti();
      return true;
    }

    /************** Confetti **************/
    function fitCanvas(){
      confettiCanvas.width=window.innerWidth;
      confettiCanvas.height=window.innerHeight;
    }
    window.addEventListener("resize",fitCanvas);
    fitCanvas();

    function confetti(){
      const pieces=[];
      for(let i=0;i<150;i++){
        pieces.push({
          x:Math.random()*confettiCanvas.width,
          y:Math.random()*confettiCanvas.height/2,
          r:Math.random()*6+4,
          c:["#ea3b2d","#27c93f","#2f7bff","#ffcc00","#00d8ff"][Math.floor(Math.random()*5)],
          d:Math.random()*3+2
        });
      }
      let frame=0;
      function animate(){
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        pieces.forEach(p=>{
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,2*Math.PI);
          ctx.fillStyle=p.c;
          ctx.fill();
          p.y+=p.d;
        });
        frame++;
        if(frame<120) requestAnimationFrame(animate);
      }
      animate();
    }

    /************** Init **************/
    for(let i=1;i<=6;i++){
      const o=document.createElement("option");
      o.value=i;o.textContent="مستوى "+i;
      levelSel.appendChild(o);
    }
    for(let i=1;i<=10;i++){
      const o=document.createElement("option");
      o.value=i;o.textContent="مرحلة "+i;
      stageSel.appendChild(o);
    }

    levelSel.addEventListener("change",e=>newStage(+e.target.value,currentStage));
    stageSel.addEventListener("change",e=>newStage(currentLevel,+e.target.value));
    btnReset.addEventListener("click",resetStage);
    btnCheck.addEventListener("click",checkBoard);
    btnNext.addEventListener("click",()=>{
      let nextStage=currentStage+1;
      let nextLevel=currentLevel;
      if(nextStage>10){nextStage=1;nextLevel++;}
      if(nextLevel>6){statusEl.textContent="🎉 أنهيت كل المستويات!";return;}
      newStage(nextLevel,nextStage);
    });

    newStage(1,1);
  </script>
</body>
</html>