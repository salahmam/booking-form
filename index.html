from pathlib import Path

# نقرأ الملف الأصلي اللي رفعه المستخدم
orig_path = Path("/mnt/data/sudoku_yalla_levels.html")
content = orig_path.read_text(encoding="utf-8")

# تعديل: اضافة select خاص بالمستوى + stage ، وضبط inputmode
# سنقوم بحقن select للمستوى قبل select المرحلة
import re

# 1. تعديل الهيدر لإضافة select خاص بالمستوى
content = content.replace(
    '<label for="stage">المستوى:</label>',
    '<label for="level">المستوى:</label>\n        <select id="level" aria-label="اختيار المستوى"></select>\n        <label for="stage">المرحلة:</label>'
)

# 2. إضافة inputmode للنصوص القابلة للتحرير داخل buildBoard
content = re.sub(
    r'(div\.dataset\.editable = "true";\n\s*div\.setAttribute\("aria-readonly", "false"\);)',
    r'\1\n            div.setAttribute("inputmode","numeric");\n            div.setAttribute("pattern","[0-9]*");',
    content
)

# 3. تعديل إدارة المراحل لإضافة المستويات 1-6 وكل مستوى 10 مراحل
# مكان buildStageSelector سنبني دالتين: buildLevelSelector و buildStageSelector
content = content.replace("function buildStageSelector()", "function buildSelectors()")

# سنغير استدعاء buildStageSelector() إلى buildSelectors()
content = content.replace("buildStageSelector();", "buildSelectors();")

# تعديل نصوص لاضافة level
# (سنضيف دالة buildSelectors بعد مكان buildStageSelector الاصلي)

selectors_code = """
    function buildSelectors(){
      stageSel.innerHTML = "";
      levelSel.innerHTML = "";
      for(let l=1;l<=6;l++){
        const opt=document.createElement("option");
        opt.value=l; opt.textContent=`مستوى ${l}`;
        levelSel.appendChild(opt);
      }
      for(let i=1;i<=10;i++){
        const opt=document.createElement("option");
        opt.value=i; opt.textContent=`مرحلة ${i}`;
        stageSel.appendChild(opt);
      }
      levelSel.value=currentLevel;
      stageSel.value=currentStage;
    }
"""

# إذا موجود الدالة القديمة نستبدلها
content = re.sub(r'function buildSelectors\([\s\S]*?\}', selectors_code, content)

# إضافة تعريف المتغير levelSel
content = content.replace('const stageSel = $("#stage");',
                          'const stageSel = $("#stage");\n    const levelSel = $("#level");')

# تعديل newStage ليأخذ مستوى + مرحلة
content = content.replace("function newStage(stage){",
                          "function newStage(stage, level=currentLevel){\n      currentLevel=level;")

# حفظ الملف الجديد
new_path = Path("/mnt/data/sudoku_yalla_levels_full_fixed.html")
new_path.write_text(content, encoding="utf-8")
new_path